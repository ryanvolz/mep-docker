# SPDX-FileCopyrightText: Copyright (c) 2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
scheduler:
  worker_thread_number: 8
  stop_on_deadlock: true
  stop_on_deadlock_timeout: 500

pipeline:
  selector: false
  converter: true
  rotator: false
  resampler0: false
  resampler1: true
  resampler2: true

packet:
  batch_size: &batch_size 6250 # Number of packets to process at once into tensor data
  max_packet_size: &max_packet_size 8256
  num_subchannels: &num_subchannels 1 # Number of IQ subchannels of data that form a sample
  num_samples: &rx_chunk_size 12800000 # Number of samples to output as a single chunk, must fit one batch of packets
  buffer_size: 10 # Number of num_samples chunks to store in the rx buffer
  spoof_header: true
  packet_skip_bytes: 0
  header_metadata:
    start_sample_idx: 0
    sample_rate_numerator: 64000000
    sample_rate_denominator: 1
    freq_idx: 0
    num_subchannels: *num_subchannels
    pkt_samples: 2048
    bits_per_int: 16
    is_complex: 1

basic_network:
  batch_size: *batch_size # Number of packets in a batch
  max_payload_size: *max_packet_size # Maximum payload size
  dst_port: 60133 # UDP destination port for packets
  l4_proto: udp # Layer 4 protocol
  ip_addr: 0.0.0.0 # Destination IP address

advanced_network:
  cfg:
    version: 1
    master_core: 1 # Master CPU core
    rx:
      - if_name: 0004:01:00.0 # PCIe BFD of NIC
        flow_isolation: true
        queues:
          - name: "RF Samples Ch0"
            id: 0
            gpu_device: 0
            gpu_direct: true
            split_boundary: 42
            cpu_cores: "2"
            max_packet_size: *max_packet_size # Maximum payload size
            num_concurrent_batches: 15 # Number of batches that can be used at any time
            batch_size: *batch_size # Number of packets in a batch
            output_port: "ch0"
        flows:
          - name: "UDP 60133 - Ch0"
            action:
              type: queue
              id: 0
            match:
              udp_src: 60133
              udp_dst: 60133

selector:
  subchannel_idx: [0]

rotator:
  cycle_duration_secs: 1
  cycle_start_timestamp: 0
  schedule:
    - start: 0
      freq: 0e+6

resampler1:
  chunk_size: *rx_chunk_size
  num_subchannels: *num_subchannels
  up: 1
  down: 4
  # scipy.signal.kaiserord(100, .2)
  # scipy.signal.firwin(63, 1/4, window=('kaiser', 10.06126))
  filter_coefs:
    [
      -2.432986354338939902e-06,
      -1.201387301755816774e-05,
      -2.010498573383628115e-05,
      4.865785110597989198e-20,
      7.234990153682062798e-05,
      1.718833047653556192e-04,
      1.936611739202120279e-04,
      -3.075496883998056510e-19,
      -4.371133391839054504e-04,
      -8.871516936482441804e-04,
      -8.784067619253728160e-04,
      1.042633239824355963e-18,
      1.619716840871448203e-03,
      3.030881092474629977e-03,
      2.794442692477808014e-03,
      -2.491560614216840016e-18,
      -4.576011787082063208e-03,
      -8.151611658702415109e-03,
      -7.198316142465801051e-03,
      4.637485763314281690e-18,
      1.100614435068092249e-02,
      1.912193894312655060e-02,
      1.658519934592679254e-02,
      -7.054821738079720252e-18,
      -2.513162444027867287e-02,
      -4.429275629171359335e-02,
      -3.972771271168364093e-02,
      8.997958484987521336e-18,
      7.173841174691804323e-02,
      1.560196258815701176e-01,
      2.239619030958457935e-01,
      2.499981966033499314e-01,
      2.239619030958457935e-01,
      1.560196258815701176e-01,
      7.173841174691804323e-02,
      8.997958484987521336e-18,
      -3.972771271168364093e-02,
      -4.429275629171359335e-02,
      -2.513162444027867287e-02,
      -7.054821738079720252e-18,
      1.658519934592679254e-02,
      1.912193894312655060e-02,
      1.100614435068092249e-02,
      4.637485763314281690e-18,
      -7.198316142465801051e-03,
      -8.151611658702415109e-03,
      -4.576011787082063208e-03,
      -2.491560614216840016e-18,
      2.794442692477808014e-03,
      3.030881092474629977e-03,
      1.619716840871448203e-03,
      1.042633239824355963e-18,
      -8.784067619253728160e-04,
      -8.871516936482441804e-04,
      -4.371133391839054504e-04,
      -3.075496883998056510e-19,
      1.936611739202120279e-04,
      1.718833047653556192e-04,
      7.234990153682062798e-05,
      4.865785110597989198e-20,
      -2.010498573383628115e-05,
      -1.201387301755816774e-05,
      -2.432986354338939902e-06,
    ]

resampler2:
  chunk_size: 3200000
  num_subchannels: *num_subchannels
  up: 5
  down: 8
  # scipy.signal.kaiserord(81, .1 / 5)
  # 5 * scipy.signal.firwin(511, 5/8/5, window=('kaiser', 7.96746))
  filter_coefs:
    [
      -5.758886602046732855e-06,
      -1.205182991173103278e-05,
      -1.770930123156498360e-05,
      -2.142744989959185484e-05,
      -2.201255122825098397e-05,
      -1.864644518029594811e-05,
      -1.112248527567636584e-05,
      2.345472397272811431e-19,
      1.336616417763174766e-05,
      2.694619783009448864e-05,
      3.830555101059647088e-05,
      4.499544377279865838e-05,
      4.500713557820148190e-05,
      3.721347458044215552e-05,
      2.171316952162471114e-05,
      -6.581490003771069499e-19,
      -2.509865398001468275e-05,
      -4.973429376955000873e-05,
      -6.957767971167877518e-05,
      -8.051942452756168361e-05,
      -7.942547932800200577e-05,
      -6.481914253108837624e-05,
      -3.735863926619750351e-05,
      -1.285516932385181110e-22,
      4.222218723004626920e-05,
      8.280377548130502527e-05,
      1.147094853094490834e-04,
      1.315155422190085607e-04,
      1.285813048428935033e-04,
      1.040499771508886792e-04,
      5.948615499139237327e-05,
      -5.626051740520231074e-19,
      -6.621953211139434579e-05,
      -1.289462923323520460e-04,
      -1.774166682862106685e-04,
      -2.020800218587139930e-04,
      -1.963282269002950562e-04,
      -1.579087307308633037e-04,
      -8.974984736041910667e-05,
      1.688388372421721472e-18,
      9.880350211059684361e-05,
      1.913814548369490451e-04,
      2.619778348273570263e-04,
      2.969223975053829128e-04,
      2.870901752283229989e-04,
      2.298374628227672141e-04,
      1.300431091805709578e-04,
      1.392450147330969147e-18,
      -1.419291750892828373e-04,
      -2.737792815486467918e-04,
      -3.732636814159895323e-04,
      -4.213969777649782377e-04,
      -4.058903819898140798e-04,
      -3.237396885125980888e-04,
      -1.825105762620412989e-04,
      -2.438804096079828799e-19,
      1.978059106688058347e-04,
      3.802824858573627129e-04,
      5.167662653759963432e-04,
      5.815347432013301008e-04,
      5.583810999502657755e-04,
      4.440033544586926466e-04,
      2.495607098021514246e-04,
      -1.989969793070352445e-18,
      -2.689103020098193597e-04,
      -5.155308217707745217e-04,
      -6.986314226757756865e-04,
      -7.840791704732194426e-04,
      -7.508774533451845808e-04,
      -5.955273836433518878e-04,
      -3.338805404939439213e-04,
      5.755179587400016671e-18,
      3.580017839693183808e-04,
      6.846908279318260218e-04,
      9.256989089907808384e-04,
      1.036531175132072297e-03,
      9.904004469007874310e-04,
      7.837558166235444141e-04,
      4.384548560161659510e-04,
      -1.160316137300871497e-17,
      -4.681433945147333480e-04,
      -8.934957936900703819e-04,
      -1.205556851780713225e-03,
      -1.347210624172139048e-03,
      -1.284736324633782610e-03,
      -1.014725298310225005e-03,
      -5.665930810148531388e-04,
      -1.498145064100543503e-18,
      6.027312309220913579e-04,
      1.148302777959718697e-03,
      1.546619828483388175e-03,
      1.725344941103413915e-03,
      1.642522424084426422e-03,
      1.295134013722911565e-03,
      7.219684261269112332e-04,
      -4.758659906619233058e-18,
      -7.655375847686232259e-04,
      -1.456176291816940836e-03,
      -1.958243676616146494e-03,
      -2.181199609818018116e-03,
      -2.073373804955837112e-03,
      -1.632443481711908992e-03,
      -9.086757526904026914e-04,
      1.435672432524016276e-17,
      9.607747860434084908e-04,
      1.825012213662938676e-03,
      2.450895556983369392e-03,
      2.726271524667882220e-03,
      2.588070878076979223e-03,
      2.035029388606792410e-03,
      1.131317309752568820e-03,
      -6.693025877888984298e-18,
      -1.193189773420944358e-03,
      -2.263721303406212703e-03,
      -3.036405752554773105e-03,
      -3.373575195171670243e-03,
      -3.198837066882671658e-03,
      -2.512404737235517625e-03,
      -1.395129542106173046e-03,
      -5.501059897649869922e-18,
      1.468203895092915975e-03,
      2.782500424334850061e-03,
      3.728339734150898279e-03,
      4.138065576395108525e-03,
      3.919748958020653068e-03,
      3.075549439557224724e-03,
      1.706170374934539704e-03,
      -8.953849178928862021e-18,
      -1.792119385471653299e-03,
      -3.393233153039349262e-03,
      -4.542547797164606972e-03,
      -5.037262818538949111e-03,
      -4.767342468499094488e-03,
      -3.737397578389238788e-03,
      -2.071596194929204490e-03,
      2.987918146916906888e-17,
      2.172425019810130930e-03,
      4.110083157981484284e-03,
      5.497979703207113260e-03,
      6.092178901898442391e-03,
      5.761512630533675502e-03,
      4.513561317265649651e-03,
      2.500073740210244019e-03,
      -1.146297908807727766e-17,
      -2.618251605858786576e-03,
      -4.950379502612685390e-03,
      -6.617901629093462905e-03,
      -7.328703739854562811e-03,
      -6.926861444280053154e-03,
      -5.423416929779789099e-03,
      -3.002399011516078669e-03,
      -1.573438054301882802e-17,
      3.141058767597082642e-03,
      5.935953963583111628e-03,
      7.931738028124355952e-03,
      8.779707315163299414e-03,
      8.294746340877613006e-03,
      6.491758997736203803e-03,
      3.592442148648960706e-03,
      -1.410585153279238968e-17,
      -3.755688583083274020e-03,
      -7.095198015559250546e-03,
      -9.477912299237497423e-03,
      -1.048829081493016756e-02,
      -9.906457467689103180e-03,
      -7.751373848941990261e-03,
      -4.288621927741402204e-03,
      5.613559730652777319e-17,
      4.482020526074035650e-03,
      8.466304758777376885e-03,
      1.130833962965196310e-02,
      1.251294737168134712e-02,
      1.181828011517898659e-02,
      9.247155710320236616e-03,
      5.116273576319853994e-03,
      -1.673880320037218519e-17,
      -5.347651215110550173e-03,
      -1.010254119851329048e-02,
      -1.349576629460497862e-02,
      -1.493603120795186298e-02,
      -1.410984184838819967e-02,
      -1.104292662717250469e-02,
      -6.111591568750671978e-03,
      1.800151164109064856e-17,
      6.392403332125097884e-03,
      1.208116758625872936e-02,
      1.614625529444060903e-02,
      1.787824818239282937e-02,
      1.689847867137334730e-02,
      1.323324544360810623e-02,
      7.328499366348622916e-03,
      -1.920076102090642186e-17,
      -7.676284340379146975e-03,
      -1.451928781463182085e-02,
      -1.942152915403210639e-02,
      -2.152477241026157923e-02,
      -2.036531860470474145e-02,
      -1.596501133356691138e-02,
      -8.851315255673581489e-03,
      2.031614121471107582e-17,
      9.294400676081561799e-03,
      1.760380558436074744e-02,
      2.358156744615949596e-02,
      2.617548977939836152e-02,
      2.480593024372950914e-02,
      1.947981711774922700e-02,
      1.081983023238240402e-02,
      -2.132810617625551554e-17,
      -1.140710614666799044e-02,
      -2.165264216965476565e-02,
      -2.907264286031462086e-02,
      -3.235005077326298661e-02,
      -3.073750458662940707e-02,
      -2.420470040474406032e-02,
      -1.348374076390231741e-02,
      2.221848522837872846e-17,
      1.430724851077116132e-02,
      2.725326502223604855e-02,
      3.672954015291067520e-02,
      4.103296089678123981e-02,
      3.915299426316989906e-02,
      3.097098370764119618e-02,
      1.733623801143501994e-02,
      -2.297096789305304464e-17,
      -1.859151678672529839e-02,
      -3.562281503847643249e-02,
      -4.831241439674168608e-02,
      -5.433874521860872220e-02,
      -5.222697381093327484e-02,
      -4.163705832751417313e-02,
      -2.350404767161159980e-02,
      2.357154606331872828e-17,
      2.568933445919922842e-02,
      4.975386833397036496e-02,
      6.827061457195403305e-02,
      7.777334342349920271e-02,
      7.580456013069816756e-02,
      6.137178661617551101e-02,
      3.523867667545978882e-02,
      -2.400889855778044995e-17,
      -4.008411200089710691e-02,
      -7.948832252788350095e-02,
      -1.120187950818643391e-01,
      -1.315407342351102016e-01,
      -1.327507142132976492e-01,
      -1.118979225158465429e-01,
      -6.736078331639548666e-02,
      2.427470491997382503e-17,
      8.676568726041453128e-02,
      1.871818059703536652e-01,
      2.936627912772832305e-01,
      3.975278039585112277e-01,
      4.898868051887302899e-01,
      5.625757981821661868e-01,
      6.090323049047217108e-01,
      6.250077910688462968e-01,
      6.090323049047217108e-01,
      5.625757981821661868e-01,
      4.898868051887302899e-01,
      3.975278039585112277e-01,
      2.936627912772832305e-01,
      1.871818059703536652e-01,
      8.676568726041453128e-02,
      2.427470491997382503e-17,
      -6.736078331639548666e-02,
      -1.118979225158465429e-01,
      -1.327507142132976492e-01,
      -1.315407342351102016e-01,
      -1.120187950818643391e-01,
      -7.948832252788350095e-02,
      -4.008411200089710691e-02,
      -2.400889855778044995e-17,
      3.523867667545978882e-02,
      6.137178661617551101e-02,
      7.580456013069816756e-02,
      7.777334342349920271e-02,
      6.827061457195403305e-02,
      4.975386833397036496e-02,
      2.568933445919922842e-02,
      2.357154606331872828e-17,
      -2.350404767161159980e-02,
      -4.163705832751417313e-02,
      -5.222697381093327484e-02,
      -5.433874521860872220e-02,
      -4.831241439674168608e-02,
      -3.562281503847643249e-02,
      -1.859151678672529839e-02,
      -2.297096789305304464e-17,
      1.733623801143501994e-02,
      3.097098370764119618e-02,
      3.915299426316989906e-02,
      4.103296089678123981e-02,
      3.672954015291067520e-02,
      2.725326502223604855e-02,
      1.430724851077116132e-02,
      2.221848522837872846e-17,
      -1.348374076390231741e-02,
      -2.420470040474406032e-02,
      -3.073750458662940707e-02,
      -3.235005077326298661e-02,
      -2.907264286031462086e-02,
      -2.165264216965476565e-02,
      -1.140710614666799044e-02,
      -2.132810617625551554e-17,
      1.081983023238240402e-02,
      1.947981711774922700e-02,
      2.480593024372950914e-02,
      2.617548977939836152e-02,
      2.358156744615949596e-02,
      1.760380558436074744e-02,
      9.294400676081561799e-03,
      2.031614121471107582e-17,
      -8.851315255673581489e-03,
      -1.596501133356691138e-02,
      -2.036531860470474145e-02,
      -2.152477241026157923e-02,
      -1.942152915403210639e-02,
      -1.451928781463182085e-02,
      -7.676284340379146975e-03,
      -1.920076102090642186e-17,
      7.328499366348622916e-03,
      1.323324544360810623e-02,
      1.689847867137334730e-02,
      1.787824818239282937e-02,
      1.614625529444060903e-02,
      1.208116758625872936e-02,
      6.392403332125097884e-03,
      1.800151164109064856e-17,
      -6.111591568750671978e-03,
      -1.104292662717250469e-02,
      -1.410984184838819967e-02,
      -1.493603120795186298e-02,
      -1.349576629460497862e-02,
      -1.010254119851329048e-02,
      -5.347651215110550173e-03,
      -1.673880320037218519e-17,
      5.116273576319853994e-03,
      9.247155710320236616e-03,
      1.181828011517898659e-02,
      1.251294737168134712e-02,
      1.130833962965196310e-02,
      8.466304758777376885e-03,
      4.482020526074035650e-03,
      5.613559730652777319e-17,
      -4.288621927741402204e-03,
      -7.751373848941990261e-03,
      -9.906457467689103180e-03,
      -1.048829081493016756e-02,
      -9.477912299237497423e-03,
      -7.095198015559250546e-03,
      -3.755688583083274020e-03,
      -1.410585153279238968e-17,
      3.592442148648960706e-03,
      6.491758997736203803e-03,
      8.294746340877613006e-03,
      8.779707315163299414e-03,
      7.931738028124355952e-03,
      5.935953963583111628e-03,
      3.141058767597082642e-03,
      -1.573438054301882802e-17,
      -3.002399011516078669e-03,
      -5.423416929779789099e-03,
      -6.926861444280053154e-03,
      -7.328703739854562811e-03,
      -6.617901629093462905e-03,
      -4.950379502612685390e-03,
      -2.618251605858786576e-03,
      -1.146297908807727766e-17,
      2.500073740210244019e-03,
      4.513561317265649651e-03,
      5.761512630533675502e-03,
      6.092178901898442391e-03,
      5.497979703207113260e-03,
      4.110083157981484284e-03,
      2.172425019810130930e-03,
      2.987918146916906888e-17,
      -2.071596194929204490e-03,
      -3.737397578389238788e-03,
      -4.767342468499094488e-03,
      -5.037262818538949111e-03,
      -4.542547797164606972e-03,
      -3.393233153039349262e-03,
      -1.792119385471653299e-03,
      -8.953849178928862021e-18,
      1.706170374934539704e-03,
      3.075549439557224724e-03,
      3.919748958020653068e-03,
      4.138065576395108525e-03,
      3.728339734150898279e-03,
      2.782500424334850061e-03,
      1.468203895092915975e-03,
      -5.501059897649869922e-18,
      -1.395129542106173046e-03,
      -2.512404737235517625e-03,
      -3.198837066882671658e-03,
      -3.373575195171670243e-03,
      -3.036405752554773105e-03,
      -2.263721303406212703e-03,
      -1.193189773420944358e-03,
      -6.693025877888984298e-18,
      1.131317309752568820e-03,
      2.035029388606792410e-03,
      2.588070878076979223e-03,
      2.726271524667882220e-03,
      2.450895556983369392e-03,
      1.825012213662938676e-03,
      9.607747860434084908e-04,
      1.435672432524016276e-17,
      -9.086757526904026914e-04,
      -1.632443481711908992e-03,
      -2.073373804955837112e-03,
      -2.181199609818018116e-03,
      -1.958243676616146494e-03,
      -1.456176291816940836e-03,
      -7.655375847686232259e-04,
      -4.758659906619233058e-18,
      7.219684261269112332e-04,
      1.295134013722911565e-03,
      1.642522424084426422e-03,
      1.725344941103413915e-03,
      1.546619828483388175e-03,
      1.148302777959718697e-03,
      6.027312309220913579e-04,
      -1.498145064100543503e-18,
      -5.665930810148531388e-04,
      -1.014725298310225005e-03,
      -1.284736324633782610e-03,
      -1.347210624172139048e-03,
      -1.205556851780713225e-03,
      -8.934957936900703819e-04,
      -4.681433945147333480e-04,
      -1.160316137300871497e-17,
      4.384548560161659510e-04,
      7.837558166235444141e-04,
      9.904004469007874310e-04,
      1.036531175132072297e-03,
      9.256989089907808384e-04,
      6.846908279318260218e-04,
      3.580017839693183808e-04,
      5.755179587400016671e-18,
      -3.338805404939439213e-04,
      -5.955273836433518878e-04,
      -7.508774533451845808e-04,
      -7.840791704732194426e-04,
      -6.986314226757756865e-04,
      -5.155308217707745217e-04,
      -2.689103020098193597e-04,
      -1.989969793070352445e-18,
      2.495607098021514246e-04,
      4.440033544586926466e-04,
      5.583810999502657755e-04,
      5.815347432013301008e-04,
      5.167662653759963432e-04,
      3.802824858573627129e-04,
      1.978059106688058347e-04,
      -2.438804096079828799e-19,
      -1.825105762620412989e-04,
      -3.237396885125980888e-04,
      -4.058903819898140798e-04,
      -4.213969777649782377e-04,
      -3.732636814159895323e-04,
      -2.737792815486467918e-04,
      -1.419291750892828373e-04,
      1.392450147330969147e-18,
      1.300431091805709578e-04,
      2.298374628227672141e-04,
      2.870901752283229989e-04,
      2.969223975053829128e-04,
      2.619778348273570263e-04,
      1.913814548369490451e-04,
      9.880350211059684361e-05,
      1.688388372421721472e-18,
      -8.974984736041910667e-05,
      -1.579087307308633037e-04,
      -1.963282269002950562e-04,
      -2.020800218587139930e-04,
      -1.774166682862106685e-04,
      -1.289462923323520460e-04,
      -6.621953211139434579e-05,
      -5.626051740520231074e-19,
      5.948615499139237327e-05,
      1.040499771508886792e-04,
      1.285813048428935033e-04,
      1.315155422190085607e-04,
      1.147094853094490834e-04,
      8.280377548130502527e-05,
      4.222218723004626920e-05,
      -1.285516932385181110e-22,
      -3.735863926619750351e-05,
      -6.481914253108837624e-05,
      -7.942547932800200577e-05,
      -8.051942452756168361e-05,
      -6.957767971167877518e-05,
      -4.973429376955000873e-05,
      -2.509865398001468275e-05,
      -6.581490003771069499e-19,
      2.171316952162471114e-05,
      3.721347458044215552e-05,
      4.500713557820148190e-05,
      4.499544377279865838e-05,
      3.830555101059647088e-05,
      2.694619783009448864e-05,
      1.336616417763174766e-05,
      2.345472397272811431e-19,
      -1.112248527567636584e-05,
      -1.864644518029594811e-05,
      -2.201255122825098397e-05,
      -2.142744989959185484e-05,
      -1.770930123156498360e-05,
      -1.205182991173103278e-05,
      -5.758886602046732855e-06,
    ]

drf_sink:
  chunk_size: &drf_chunk_size 2000000
  num_subchannels: *num_subchannels
  channel_dir: sr10MHz
  uuid: mep_pipeline_sr10MHz
